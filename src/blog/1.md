# **HTTPS Note**

# PKI 系統

Public key 加密方法，典型代表是 RSA 演算法，透過亂數生成的一組對稱的
`Public Key` & `Private Key`，可以達到

加密(明文, Public Key) -> 只能透過 Private Key 解密
加密(明文, Private Key) -> 只能透過 Public Key 解密

進而完成安全性上所需的加解密/簽章等需求。

# 相關的檔案格式

- 單一張憑證的儲存

DER - 二進位的憑證資料，打開通常...不!你不會看到任何你認識的東西XD

PEM - 將 DER 格式用 Base64 編碼再在前後加上 `-----BEGIN CERTIFICATE-----` 和 `-----END CERTIFICATE-----`，如下：

```
-----BEGIN CERTIFICATE-----
MIIDezCCAmOgAwIBAgIBATANBgkqhkiG9w0BAQUFADBfMQswCQYDVQQGEwJUVzES
MBAGA1UECgwJVEFJV0FOLUNBMRAwDgYDVQQLDAdSb290IENBMSowKAYDVQQDDCFU
V0NBIFJvb3QgQ2VydGlmaWNhdGlvbiBBdXRob3JpdHkwHhcNMDgwODI4MDcyNDMz
WhcNMzAxMjMxMTU1OTU5WjBfMQswCQYDVQQGEwJUVzESMBAGA1UECgwJVEFJV0FO
LUNBMRAwDgYDVQQLDAdSb290IENBMSowKAYDVQQDDCFUV0NBIFJvb3QgQ2VydGlm
aWNhdGlvbiBBdXRob3JpdHkwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIB
AQCwfnK4pAOU5qfeCTiRShFAh6d8WWQUe7UREN3+v9XAu1bihSX0NXIP+FPQQeFE
AcK0HMMxQhZHhTMidrIKbw/lJVBPhYa+v5guEGcevhEFhgWQxFnQfHgQsIBct+HH
K3XLfJ+utdGdIzdjp9xCoi2SBBtQwXu4PhvJVgSLL1KbralW6cH/ralYhzC2gfeX
RfwZVzsrb+RH9JlF/h3x+JejiB03HFyP4HYlmlD4oFT/RJB2I9IyxsOrBr/8+7/z
rX2SYgJbKdM1o5OaQ2RgXbL6Mv87BK9NQGr5x+PvI/1ry+UPizgN7gr8/g+YnzAx
3WxSZfmLgb4i4RxYA7qRG4kHAgMBAAGjQjBAMA4GA1UdDwEB/wQEAwIBBjAPBgNV
HRMBAf8EBTADAQH/MB0GA1UdDgQWBBRqOFsmjd6LWvJPelSDGRjjCDWmujANBgkq
hkiG9w0BAQUFAAOCAQEAPNV3PdrfibqHDAhUaiBQkr6wQT25JmSDCi/oQMCXKCeC
MErJk/9q56YAf4lCmtYR5VPOL8zy2gXE/uJQxDqGfczafhAJO5I1KlOy/usrBdls
XebQ79NqZp4VKIV66IIArB6nCWlWQtNoURi+VJq/REG6Sb4gumlc7rh3zc5sH62D
lhh9DrUUOYTxKOkto557HnpyWoOzeW/vtPzQCqVYT0bf+215WfKEIlKuD8z7fDvn
aspHYcN6+NOSBB+4IIThNlQWx0DeO4pz3N/GCUzf7Nr/1FNCocnyYh0igzyXxfkZ
YiesZSLX0zzG5Y6yU8xJzrww/nsOM5D77dIUkR8Hrw==
-----END CERTIFICATE-----

```

CER, CRT, DER - 這幾個副檔名，**通常**使用的是 `DER` 格式，但在裡面裝 `PEM` 格式也很常見

NET - **待補**


- 以下是金鑰儲存庫 (可以儲存一~多張憑證 & Private Key)

P12,PFX - P12(PKCS#12),PFX(P12的下一版) 都是憑證的儲存庫 (搭配 `openssl pkcs12`) 指令操作

JKS - Java 使用的儲存庫 (搭配 `keytool` 指令操作)

- 會這樣用但沒有什麼標準

KEY - Private Key，通常用 `PEM` 格式，可用以下指令檢查

```
openssl rsa -in [XXX].key -text
或
openssl rsa -in [XXX].key -check
```

# HTTPS 概要

- 版本演進: SSL 1.0 -> 2.0 -> 3.0 -> TLS 1.0(1999) -> 1.1(2006) -> 1.2 (2008)
- SSL 3.0 在2014年被發現設計缺陷，已被建議停用
- SSL 3.0 和 TLS 1.0 相容，採用幾乎相同的協定內容

- SSL 憑證目前主要基於 X.509，使用OpenPGP的憑證正在研議中

## HTTPS cipher suite

在 HTTPS 中加密使用的組合，共有以下選項，這些選項會在 HTTPS 初始化時，
由 Client 送出支援的演算法，並由 Server 決定實際上使用的 cipher suite
1. Key exchange(Kx)
2. Authentication(Au)
3. Block cipher(Enc)
4. HMAC(Mac)

一個有效的 Cipher 名稱通常像這樣 `ECDHE-RSA-AES256-GCM-SHA384`
，表示在這個 Cipher suite 中

1. Key exchange(Kx): **ECDH**
2. Authentication(Au): **RSA**
3. Block cipher(Enc): **AESGCM(256)**
4. HMAC(Mac): **AEAD** (表示[不需要實際MAC](https://security.stackexchange.com/questions/57423/openssl-ciphers-sha384-and-aead)，這裡有點技術細節可先忽略)

## 下載網站的 certificate

使用指令（但目前不支援透過 proxy 取得）

```
openssl s_client -connect {HOSTNAME}:{PORT} -showcerts
```

https://superuser.com/questions/97201/how-to-save-a-remote-server-ssl-certificate-locally-as-a-file

## 列出伺服器端支援的 Cipher Suite (bash script)

https://superuser.com/questions/109213/how-do-i-list-the-ssl-tls-cipher-suites-a-particular-website-offers

```
#!/usr/bin/env bash

# OpenSSL requires the port number.
SERVER=$1
DELAY=1
ciphers=$(openssl ciphers 'ALL:eNULL' | sed -e 's/:/ /g')

echo Obtaining cipher list from $(openssl version).

for cipher in ${ciphers[@]}
do
echo -n Testing $cipher...
result=$(echo -n | openssl s_client -cipher "$cipher" -connect $SERVER 2>&1)
if [[ "$result" =~ ":error:" ]] ; then
  error=$(echo -n $result | cut -d':' -f6)
  echo NO \($error\)
else
  if [[ "$result" =~ "Cipher is ${cipher}" || "$result" =~ "Cipher    :" ]] ; then
    echo YES
  else
    echo UNKNOWN RESPONSE
    echo $result
  fi
fi
sleep $DELAY
done
```

## 檢查目前瀏覽器支援的 Cipher Suite

https://cc.dcsec.uni-hannover.de/


# JBoss HTTPS

- jeap 限制使用的 https 版本
https://stackoverflow.com/questions/23668951/how-to-change-ssl-version-for-https-connections-in-jboss-eap-6-1

# HTTPS Client Certification


# Java 的 Certificate 匯入相關

- TODO
https://stackoverflow.com/questions/4325263/how-to-import-a-cer-certificate-into-a-java-keystore

## MacOS 預設的 JDK security 目錄位置

```
/Library/Java/JavaVirtualMachines/jdk1.8.0_141.jdk/Contents/Home/jre/lib/security
```


# 參考文件

- [Wiki: X509][wiki_x509]

[wiki_x509]: https://en.wikipedia.org/wiki/X.509

